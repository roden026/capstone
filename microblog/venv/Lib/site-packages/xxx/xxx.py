# -*- coding:utf-8 -*-

"""
初始化日志、数据库连接，启动服务器心跳

Author: huangtao
Date:   2017/04/26
Update: 2018/07/16  1. 初始化日志增加参数 clear 和 backup_count；
"""

import asyncio

from xxx.utils import logger
from xxx.config import config


class XXX(object):
    """ 初始化日志、数据库连接，启动服务器心跳
    """

    def __init__(self, config_moudle):
        """ 初始化
        @param setting_module 配置模块
        """
        self.loop = None
        self.config_moudle = config_moudle

        self._get_event_loop()
        self._load_settings()
        self._init_logger()
        self._init_db_instance()
        self._init_event_center()
        self._do_heartbeat()

    def start(self):
        """ 启动
        """
        logger.info('start io loop ...', caller=self)
        self.loop.run_forever()

    def _get_event_loop(self):
        """ 获取主事件io loop
        """
        if not self.loop:
            self.loop = asyncio.get_event_loop()
        return self.loop

    def _load_settings(self):
        """ 加载配置
        """
        config.load_configs(self.config_moudle)

    def _init_logger(self):
        """ 初始化日志
        """
        console = config.log.get('console', True) # 是否打印日志到命令行
        level = config.log.get('level', 'DEBUG') # 打印日志的级别
        path = config.log.get('path', '/tmp/logs/XXX') # 日志文件存放的路径
        name = config.log.get('name', 'xxx.log') # 日志文件名
        clear = config.log.get('clear', False) # 是否清理历史日志
        backup_count = config.log.get('backup_count', 0) # 保存按天分割的日志文件个数
        if console:
            logger.initLogger()
        else:
            logger.initLogger(level, path, name, clear, backup_count)

    def _init_db_instance(self):
        """ 初始化数据库对象
        """
        logger.info('init db instance start >>>', caller=self)
        if config.mongodb:
            from xxx.db.mongo import initMongodb
            logger.info('mongodb config:', config.mongodb, caller=self)
            initMongodb(**config.mongodb)
        if config.redis:
            from xxx.db.redis import initRedisPool
            logger.info('redis config:', config.redis, caller=self)
            self.loop.run_until_complete(initRedisPool(**config.redis))
        logger.info('init db instance done <<<', caller=self)

    def _init_event_center(self):
        """ 初始化事件中心
        """
        if config.rabbitmq:
            logger.info('rabbitmq config:', config.rabbitmq, caller=self)
            from xxx.event.event_center import event_center
            event_center.initialize()

    def _do_heartbeat(self):
        """ 服务器心跳
        """
        from xxx.heartbeat import heartbeat
        self.loop.call_later(0.5, heartbeat.ticker)
